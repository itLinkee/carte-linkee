<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Carte Links - Pris par les citoyens ou statut</title>
    <style>
      #map {
        height: 600px;
        width: 100%;
      }
      #controls {
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>Carte Links - Pris par les citoyens ou statut</h1>

    <div id="controls">
      <label for="colorModeSelect">Colorer selon :</label>
      <select id="colorModeSelect">
        <option value="type" selected>Type</option>
        <option value="statut">Statut</option>
        <option value="Collected">Collected</option>
      </select>
    </div>

    <div id="map"></div>

    <!-- Charge la Google Maps API avec votre clé et callback=initMap -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-EiSDiT_QITPtDqZmLEJAbiFcLiSb7r0&callback=initMap"
      async
      defer
    ></script>

    <script>
      let map;
      let markers = [];
      let dataPoints = []; // Les données (points) récupérées
      let infoWindow;

      // URL du JSON avec les points
      const dataUrl = "https://raw.githubusercontent.com/itLinkee/carte-linkee/refs/heads/main/data.json";

      // Intervalle de refresh : toutes les 5 minutes
      const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 min en millisecondes

      // Dictionnaires d'icônes par type/statut
      const ICONS_BY_TYPE = {
        "Pris":     "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        "Pas pris": "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
      };
      const DEFAULT_TYPE_ICON = "https://maps.google.com/mapfiles/ms/icons/grey-dot.png";

      const ICONS_BY_STATUT = {
        "À notifier": "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
        "Collecte déclarée ok":    "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        "Collecte déclarée ko": "https://maps.google.com/mapfiles/ms/icons/grey-dot.png",
        "Panier déclaré": "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
      };

      
      const DEFAULT_STATUT_ICON = "https://maps.google.com/mapfiles/ms/icons/grey-dot.png";
      
      const ICONS_BY_COLLECT = {
        "Collecté": "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        "Livré": "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        "Annulé": "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
      };
      const DEFAULT_COLLECT_ICON = "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
      


      // ---------------------------
      // 1) Initialisation de la carte
      // ---------------------------
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 48.8566, lng: 2.3522 },
          zoom: 12,
          mapId: "e7ce213688d1abda",
        });

        infoWindow = new google.maps.InfoWindow();

        // Premier chargement des données
        loadDataAndDraw();

        // Mettre en place un rafraîchissement auto toutes les 5 minutes
        setInterval(() => {
          loadDataAndDraw();
        }, REFRESH_INTERVAL);

        // Changement du mode de coloration via le <select>
        document.getElementById("colorModeSelect").addEventListener("change", () => {
          // On redessine simplement les marqueurs avec le nouveau mode
          drawMarkers();
        });

        map.addListener("click", () => {
          infoWindow.close();
        });
      }

      // ---------------------------
      // 2) Charger (fetch) le JSON, stocker dans dataPoints, puis dessiner
      // ---------------------------
      function loadDataAndDraw() {
        fetch(dataUrl)
          .then(response => response.json())
          .then(data => {
            dataPoints = data; // Mémorise les points
            drawMarkers();    // Dessine selon le mode actuel
          })
          .catch(err => console.error("Erreur lors du fetch du JSON:", err));
      }

      // ---------------------------
      // 3) Dessiner les marqueurs selon le mode sélectionné
      // ---------------------------
      function drawMarkers() {
        clearMarkers(); // Supprime les anciens marqueurs

        // Récupère le mode (type ou statut) depuis le select
        const mode = document.getElementById("colorModeSelect").value;

        dataPoints.forEach(item => {
          let iconUrl;
          if (mode === "type") {
            iconUrl = ICONS_BY_TYPE[item.type] || DEFAULT_TYPE_ICON;
          } else if (mode === "statut") {
            iconUrl = ICONS_BY_STATUT[item.statut] || DEFAULT_STATUT_ICON;
          } else {
            iconUrl = ICONS_BY_COLLECT[item.collected] || DEFAULT_COLLECT_ICON;
          }
        

          // Création du marqueur
          const marker = new google.maps.Marker ({
            position: { lat: item.lat, lng: item.lng },
            map,
            title: item.name || "Sans nom",
            icon: iconUrl
          });

          // (Optionnel) Info-bulle
          marker.addListener("click", () => {
            const contentString = `
              <strong>${item.name}</strong><br>
              Type : ${item.type}<br>
              Statut : ${item.statut}<br>
              Asso partenaire : ${item.partenaire}<br>
              `;
            infoWindow.setContent(contentString);
            infoWindow.open(map, marker);
          });
      
          markers.push(marker);
        });
      }

      // ---------------------------
      // 4) Supprimer tous les marqueurs de la carte
      // ---------------------------
      function clearMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];
      }
    </script>
  </body>
</html>
